FROM --platform=linux/amd64 python:3.11-slim
RUN apt update && apt install --no-install-recommends --no-install-suggests -y \
   procps curl telnet tcpdump net-tools ncat \
   && rm -fr /var/lib/apt/lists/* /var/log /var/cache/apt 
RUN pip install pymongo requests tqdm
ADD mongo-shake-v2.8.4/ /app/
ADD app /app/
WORKDIR /app/
VOLUME [ "/app/logs" ]
ENV CONF_VERSION=10 \
    ID=mongoshake \
    MASTER_QUORUM=false \
    FULL_SYNC_HTTP_PORT=9101 \
    INCR_SYNC_HTTP_PORT=9100 \
    SYSTEM_PROFILE_PORT=9200 \
    LOG_LEVEL=info \
    LOG_DIR=/app/logs \
    LOG_FILE=collector.log \
    LOG_FLUSH=false \
    SYNC_MODE=incr \
    MONGO_URLS= \
    TUNNEL=direct \
    TUNNEL_ADDRESS= \
    TUNNEL_MESSAGE=raw \
    TUNNEL_KAFKA_PARTITION_NUMBER=1 \
    TUNNEL_JSON_FORMAT= \
    MONGO_CONNECT_MODE=secondaryPreferred \
    FILTER_NAMESPACE_BLACK= \
    FILTER_NAMESPACE_WHITE= \
    FILTER_PASS_SPECIAL_DB= \
    FILTER_DDL_ENABLE=false \
    FILTER_OPLOG_GIDS=false \
    CHECKPOINT_STORAGE_URL= \
    CHECKPOINT_STORAGE_DB=mongoshake \
    CHECKPOINT_STORAGE_COLLECTION=ckpt_default \
    CHECKPOINT_START_POSITION=1970-01-01T00:00:00Z \
    TRANSFORM_NAMESPACE= \
    FULL_SYNC_READER_COLLECTION_PARALLELS=6 \
    FULL_SYNC_READER_WRITE_DOCUMENT_PARALLEL=8 \
    FULL_SYNC_READER_DOCUMENT_BATCH_SIZE=128 \
    FULL_SYNC_READER_FETCH_BATCH_SIZE=8192 \
    FULL_SYNC_READER_PARALLEL_THREAD=1 \
    FULL_SYNC_READER_PARALLEL_INDEX=_id \
    FULL_SYNC_COLLECTION_EXIST_DROP=true \
    FULL_SYNC_CREATE_INDEX=foreground \
    FULL_SYNC_EXECUTOR_INSERT_ON_DUP_UPDATE=false \
    FULL_SYNC_EXECUTOR_FILTER_ORPHAN_DOCUMENT=false \
    FULL_SYNC_EXECUTOR_MAJORITY_ENABLE=false \
    INCR_SYNC_MONGO_FETCH_METHOD=oplog \
    INCR_SYNC_CHANGE_STREAM_WATCH_FULL_DOCUMENT=false \
    INCR_SYNC_OPLOG_GIDS= \
    INCR_SYNC_SHARD_KEY=collection \
    INCR_SYNC_SHARD_BY_OBJECT_ID_WHITELIST= \
    INCR_SYNC_WORKER=8 \
    INCR_SYNC_TUNNEL_WRITE_THREAD=8 \
    INCR_SYNC_TARGET_DELAY=0 \
    INCR_SYNC_WORKER_BATCH_QUEUE_SIZE=64 \
    INCR_SYNC_ADAPTIVE_BATCHING_MAX_SIZE=1024 \
    INCR_SYNC_FETCHER_BUFFER_CAPACITY=256 \
    INCR_SYNC_READER_FETCH_BATCH_SIZE=8192 \
    INCR_SYNC_EXECUTOR_UPSERT=false \
    INCR_SYNC_EXECUTOR_INSERT_ON_DUP_UPDATE=false \
    INCR_SYNC_CONFLICT_WRITE_TO=none \
    INCR_SYNC_EXECUTOR_MAJORITY_ENABLE=false \
    SPECIAL_SOURCE_DB_FLAG= \
    TZ=Asia/Shanghai
ENTRYPOINT [ "./entrypoint.sh" ]